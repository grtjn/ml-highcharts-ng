!function(){"use strict";angular.module("ml.highcharts",["highcharts-ng","ml.common","ml.highcharts.tpls","ml.search","ui.bootstrap"])}(),function(){"use strict";angular.module("ml.highcharts").controller("EditChartConfigCtrl",["$modalInstance","$scope","HighchartsHelper","facets","highchartConfig","MLSearchFactory",function(t,n,e,i,r,a){n.facetSortOptions={},n.xSortOptions={accept:function(t,n){return n.modelValue.length<1}},n.chartFacetOptions=Object.keys(i);var o=n.chartFacetOptions[0];n.chartFacetOptions.splice(0,1),n.facets=i,n.highchartConfig=r||{options:{chart:{type:"bar"},tooltip:{style:{padding:10,fontWeight:"bold"}}},title:{text:"Title"},xAxis:{title:{text:o}},xAxisMLConstraint:o,xAxisCategoriesMLConstraint:null,yAxis:{title:{text:null}},yAxisMLConstraint:"$frequency",zAxis:{title:{text:null}},size:{height:250},resultLimit:15},n.highchartConfig.xAxis||(n.highchartConfig.xAxis={title:{text:null}}),n.highchartConfig.yAxis||(n.highchartConfig.yAxis={title:{text:null}}),n.xAxisMLConstraint=[n.highchartConfig.xAxisMLConstraint],n.xAxisCategoriesMLConstraint=[n.highchartConfig.xAxisCategoriesMLConstraint],n.yAxisMLConstraint=[n.highchartConfig.yAxisMLConstraint];var s=function(){n.previewHighChart=e.chartFromConfig(n.highchartConfig)};n.chartTypes=e.chartTypes(),s(),n.$watch(function(){return n.highchartConfig.options.chart.type+n.highchartConfig.xAxis.title.text+n.highchartConfig.yAxis.title.text+n.highchartConfig.title.text+n.highchartConfig.resultLimit},function(){s()}),n.$watch(function(){return n.xAxisMLConstraint.length+""+n.yAxisMLConstraint.length+n.xAxisCategoriesMLConstraint.length},function(){n.highchartConfig.xAxisMLConstraint=n.xAxisMLConstraint[0],n.highchartConfig.yAxisMLConstraint=n.yAxisMLConstraint[0],n.highchartConfig.xAxisCategoriesMLConstraint=n.xAxisCategoriesMLConstraint[0],s()}),n.save=function(){t.close(n.highchartConfig)}}]).factory("EditChartConfigDialog",["$modal",function(t){return function(n,e){return t.open({templateUrl:"/ml-highcharts/templates/ml-highchart-config-modal.html",controller:"EditChartConfigCtrl",size:"lg",resolve:{facets:function(){return n},highchartConfig:function(){return e}}}).result}}])}(),function(){"use strict";angular.module("ml.highcharts").directive("mlHighchart",["$q","HighchartsHelper","MLRest","MLSearchFactory",function(t,n,e,i){function r(t,e,r){t.mlSearch||(t.mlSearch=i.newContext());var a=function(){t.highchartConfig&&(t.populatedConfig=n.chartFromConfig(t.highchartConfig,t.mlSearch,t.callback))},o=function(t){return function(){var n=t.apply(this,arguments);return n&&angular.isFunction(n.then)?n.then(function(t){return a(),t}):(a(),n)}},s=t.mlSearch.search;t.mlSearch.search=o(s),a()}return{restrict:"E",templateUrl:"/ml-highcharts/templates/ml-highchart.html",scope:{mlSearch:"=",highchartConfig:"=",callback:"&"},link:r}}])}(),function(){"use strict";angular.module("ml.highcharts").factory("HighchartsHelper",["$q","MLRest","MLSearchFactory",function(t,n,e){var i={};return i.seriesData=function(t,n,e){var i=[];if(e.length){var r={};angular.forEach(t,function(t){r[t.x]||(r[t.x]=[]);var n=e.indexOf(t.xCategory);r[t.x][n]=[t.xCategory,t.y]}),angular.forEach(r,function(t,r){angular.forEach(e,function(n,e){t[e]||(t[e]=[n,0])}),i.push({type:n,name:r,data:t})})}else i="pie"===n?[{type:n,data:t}]:_.map(t,function(t){return{type:n,name:t.x,data:[t.y]}});return i},i.chartFromConfig=function(t,n,r){var a=t.options.chart.type,o=angular.copy(t);return n||(n=e.newContext()),n.getStoredOptions("all").then(function(e){if(e.options&&e.options.constraint){var r=_.filter(e.options.constraint,function(t){var n=t.range||t.collection;return n&&n.facet});i.getChartData(n,r,t,t.resultLimit).then(function(t){o.series=i.seriesData(t.data,a,t.categories),t.categories&&t.categories.length&&(o.xAxis.categories=t.categories)})}}),r&&(o.options.plotOptions={series:{cursor:"pointer",point:{events:{click:function(){var t=this.name||this.series.name;r(1===t.data.length?{facet:t.data[0].__key,value:t}:{facet:this.series.name,value:t})}}}}}),o},i.getChartData=function(e,i,r,a){var o=[r.xAxisCategoriesMLConstraint,r.xAxisMLConstraint,r.yAxisMLConstraint],s={xCategoryAxis:r.xAxisCategoriesMLConstraint,xAxis:r.xAxisMLConstraint,yAxis:r.yAxisMLConstraint},c=[];if("$frequency"===r.xAxisCategoriesMLConstraint?s.frequecy="xCategory":"$frequency"===r.xAxisMLConstraint?s.frequecy="x":"$frequency"===r.yAxisMLConstraint&&(s.frequecy="y"),i&&i.length){var h=_.filter(i,function(t){return t&&t.name&&o.indexOf(t.name)>-1&&t.range}).sort(function(t,n){return o.indexOf(t.name)-o.indexOf(n.name)}),l=_.map(h,function(t){return t.range}),u=_.map(h,function(t){return t.name});s.xCategoryAxisIndex=u.indexOf(s.xCategoryAxis),s.xAxisIndex=u.indexOf(s.xAxis),s.yAxisIndex=u.indexOf(s.yAxis);var x=[{name:"cooccurrence",range:l,"values-option":["frequency-order","limit="+(a?a:"20")]}],g={search:{options:{constraint:i},query:e?e.getQuery().query:{queries:[]}}};return h.length>1?g.search.options.tuples=x:g.search.options.values=x,n.values("cooccurrence",{format:"json"},g).then(function(t){var n=[];return t.data["values-response"]&&(h.length>1?angular.forEach(t.data["values-response"].tuple,function(t){var e=t["distinct-value"],i={xCategory:e[s.xCategoryAxisIndex]?e[s.xCategoryAxisIndex]._value:null,x:e[s.xAxisIndex]?e[s.xAxisIndex]._value:null,y:e[s.yAxisIndex]?e[s.yAxisIndex]._value:null};i.xCategory&&c.indexOf(i.xCategory)<0&&c.push(i.xCategory),i.name=i.xCategory||i.x||i.y,i[s.frequecy]=t.frequency,n.push(i)}):angular.forEach(t.data["values-response"]["distinct-value"],function(t){var e={x:s.xAxisIndex>-1?t._value:null,y:s.yAxisIndex>-1?t._value:null};e.name=e.x||e.y,e[s.frequecy]=t.frequency,n.push(e)})),{data:n,categories:c}})}var f=t.defer();return f.resolve(null),f.promise},i.chartTypes=function(){return["line","spline","area","areaspline","column","bar","pie","scatter"]},i}])}();
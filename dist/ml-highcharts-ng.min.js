!function(){"use strict";angular.module("ml.highcharts",["ml.common","ml.search"])}(),function(){"use strict";angular.module("ml.highcharts").directive("mlHighchart",["$q","HighchartsHelper","MLRest","MLSearchFactory",function(e,t,n,a){function r(e,n,r){e.mlSearch=e.mlSearch||a.newContext();var i=function(){e.highchartConfig&&(e.populatedConfig=t.chartFromConfig(e.highchartConfig,e.mlSearch,e.callback))};e.$watchCollection("mlSearch.getQuery()",i)}return{restrict:"E",templateUrl:"/ml-highcharts/templates/ml-highchart.html",scope:{mlSearch:"=",highchartConfig:"=",callback:"&"},link:r}}])}(),function(){"use strict";angular.module("ml.highcharts").factory("HighchartsHelper",["$q","MLRest","MLSearchFactory",function(e,t,n){var a={};return a.seriesData=function(e,t,n){var a=[];return a=n.length?_.map(e,function(e){var a=[],r=n.indexOf(e.xCategory);return angular.forEach(n,function(t,n){a[n]=n===r?[t,e.y]:[t,0]}),{type:t,name:e.x,data:a}}):"pie"===t?[{type:t,data:e}]:_.map(e,function(e){return{type:t,name:e.x,data:[e.y]}})},a.chartFromConfig=function(e,t,r){var i=e.options.chart.type,o=angular.copy(e);return t=t||n.newContext(),t.getStoredOptions("all").then(function(n){if(n.options&&n.options.constraint){var r=_.filter(n.options.constraint,function(e){var t=e.range||e.collection;return t&&t.facet});a.getChartData(t,r,e,e.facetLimit).then(function(e){o.series=a.seriesData(e.data,i,e.categories),e.categories&&e.categories.length&&(o.xAxis.categories=e.categories)})}}),r&&(o.options.plotOptions={series:{cursor:"pointer",point:{events:{click:function(){var e=this.name||this.series.name;r(1===e.data.length?{facet:e.data[0].__key,value:e}:{facet:this.series.name,value:e})}}}}}),o},a.getChartData=function(n,a,r,i){var o=[r.xAxisCategoriesMLConstraint,r.xAxisMLConstraint,r.yAxisMLConstraint],s={xCategoryAxis:r.xAxisCategoriesMLConstraint,xAxis:r.xAxisMLConstraint,yAxis:r.yAxisMLConstraint},c=[];if("$frequency"===r.xAxisCategoriesMLConstraint?s.frequecy="xCategory":"$frequency"===r.xAxisMLConstraint?s.frequecy="x":"$frequency"===r.yAxisMLConstraint&&(s.frequecy="y"),a&&a.length){var u=_.filter(a,function(e){return e&&e.name&&o.indexOf(e.name)>-1&&e.range}).sort(function(e,t){return o.indexOf(e.name)-o.indexOf(t.name)}),l=_.map(u,function(e){return e.range}),x=_.map(u,function(e){return e.name});s.xCategoryAxisIndex=x.indexOf(s.xCategoryAxis),s.xAxisIndex=x.indexOf(s.xAxis),s.yAxisIndex=x.indexOf(s.yAxis);var h=[{name:"cooccurrence",range:l,"values-option":["frequency-order","limit="+(i?i:"20")]}],f={search:{options:{constraint:a},query:n?n.getQuery().query:{queries:[]}}};return u.length>1?f.search.options.tuples=h:f.search.options.values=h,t.values("cooccurrence",{format:"json"},f).then(function(e){var t=[];return e.data["values-response"]&&(u.length>1?angular.forEach(e.data["values-response"].tuple,function(e){var n=e["distinct-value"],a={xCategory:n[s.xCategoryAxisIndex]?n[s.xCategoryAxisIndex]._value:null,x:n[s.xAxisIndex]?n[s.xAxisIndex]._value:null,y:n[s.yAxisIndex]?n[s.yAxisIndex]._value:null};a.xCategory&&c.indexOf(a.xCategory)<0&&c.push(a.xCategory),a.name=a.xCategory||a.x||a.y,a[s.frequecy]=e.frequency,t.push(a)}):angular.forEach(e.data["values-response"]["distinct-value"],function(e){var n={x:s.xAxisIndex>-1?e._value:null,y:s.yAxisIndex>-1?e._value:null};n.name=n.x||n.y,n[s.frequecy]=e.frequency,t.push(n)})),{data:t,categories:c}})}var g=e.defer();return g.resolve(null),g.promise},a.chartTypes=function(){return["line","spline","area","areaspline","column","bar","pie","scatter"]},a}])}();
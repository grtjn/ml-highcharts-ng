!function(){"use strict";angular.module("ml.highcharts",["highcharts-ng","ml.common","ml.highcharts.tpls","ml.search","ui.bootstrap"])}(),function(){"use strict";angular.module("ml.highcharts").factory("HighchartsHelper",["$q","MLQueryBuilder","MLRest","MLSearchFactory",function(t,e,n,i){function a(t,e,n){var i={xCategoryAxis:t.xAxisCategoriesMLConstraint,xAxis:t.xAxisMLConstraint,yAxis:t.yAxisMLConstraint,zAxis:t.zAxisMLConstraint};return"$frequency"===t.xAxisCategoriesMLConstraint?i.frequency="xCategory":"$frequency"===t.xAxisMLConstraint?i.frequency="x":"$frequency"===t.yAxisMLConstraint?i.frequency="y":"$frequency"===t.zAxisMLConstraint&&(i.frequency="z"),i.facets={xCategoryAxisIndex:e.indexOf(i.xCategoryAxis),xAxisIndex:e.indexOf(i.xAxis),yAxisIndex:e.indexOf(i.yAxis),zAxisIndex:e.indexOf(i.zAxis)},i.values={xCategoryAxisIndex:n.indexOf(i.xCategoryAxis),xAxisIndex:n.indexOf(i.xAxis),yAxisIndex:n.indexOf(i.yAxis),zAxisIndex:n.indexOf(i.zAxis)},i}function r(t,e){return _.filter(t,function(t){return t&&t.name&&e.indexOf(t.name)>-1&&t.range}).sort(function(t,n){var i=t.collection?1:100,a=n.collection?1:100;return e.indexOf(t.name)*i-e.indexOf(n.name)*a})}function o(t,e,n,i,a){var r=_.map(n,function(t){return t.range}),o=_.map(n,function(t){return t.collection}),s=[{name:"cooccurrence",collection:_.without(o,null,void 0),range:_.without(r,null,void 0),"values-option":["frequency-order","limit="+(i?i:"20")]}],u=t?angular.copy(t.getQuery().query):{queries:[]};u.queries.unshift.apply(u.queries,a);var c={search:{options:{constraint:e},query:u}};return n.length>1?c.search.options.tuples=s:c.search.options.values=s,c}function s(t){if(1===t.length)return _.map(t[0].facetValues,function(e){return[{facetName:t[0].name,type:t[0].type,_value:e.value,frequecy:e.frequency,query:{qtext:'"'+t[0].name+'":"'+e.name+'"'}}]});for(var e=[],n=s(t.slice(1)),i=0;i<n.length;i++)for(var a=0;a<t[0].facetValues.length;a++)e.push(_.flatten([{facetName:t[0].name,type:t[0].type,_value:t[0].facetValues[a].value,frequecy:t[0].facetValues[a].frequency,query:{qtext:'"'+t[0].name+'":"'+t[0].facetValues[a].name+'"'}},n[i]]));return e}var u={};return u.seriesData=function(t,e,n){var i=[];if(n.length){var a={};angular.forEach(t,function(t){a[t.x]||(a[t.x]=[]);var e=n.indexOf(t.xCategory);a[t.x][e]=[t.xCategory,t.y,t.z]}),angular.forEach(a,function(t,a){angular.forEach(n,function(e,n){t[n]||(t[n]=[e,0,0])}),i.push({type:e,name:a,data:t})})}else i="pie"===e?[{type:e,data:t}]:"bubble"===e?_.map(t,function(t){return{type:e,name:t.name,data:[{x:t.x,y:t.y,z:t.z}]}}):_.map(t,function(t){return{type:e,name:t.x,data:[t.y,t.z]}});return i},u.chartFromConfig=function(t,e,n){var a=t.options.chart.type,r=angular.copy(t);return e||(e=i.newContext()),e.getStoredOptions("all").then(function(n){if(n.options&&n.options.constraint){var i=_.filter(n.options.constraint,function(t){var e=t.range||t.collection;return e&&e.facet});u.getChartData(e,i,t,t.resultLimit).then(function(t){r.series=u.seriesData(t.data,a,t.categories),t.categories&&t.categories.length&&(r.xAxis.categories=t.categories)})}}),n&&(r.options.plotOptions={series:{cursor:"pointer",point:{events:{click:function(){var t=this.name||this.series.name;n(1===t.data.length?{facet:t.data[0].__key,value:t}:{facet:this.series.name,value:t})}}}}}),r},u.getChartData=function(e,i,u,c){var l,h=_.without([u.xAxisCategoriesMLConstraint,u.xAxisMLConstraint,u.yAxisMLConstraint,u.zAxisMLConstraint],null,void 0),x=[],f=[];if(e.results.facets){var g=angular.copy(e.results.facets);angular.forEach(g,function(t,e){t.name=e}),l=t.when(g)}else l=n.search({options:e.options.queryOptions}).then(function(t){return angular.forEach(t.data.facets,function(t,e){t.name=e}),t.data.facets});return l.then(function(l){if(i&&i.length){var g=r(i,h),y=[],C=[];angular.forEach(g,function(t){t.custom||t.range&&(t.range.bucket||t.range["computed-bucket"])?y.push(l[t.name]):C.push(t)});var d,p=_.map(C,function(t){return t.name}),A=_.map(y,function(t){return t.name}),m=a(u,A,p),v=function(t){return t?t._value:null};if(d=y.length>0?s(y):[[{query:{"and-query":{queries:[]}}}]],C.length>0){var q=[];return angular.forEach(d,function(t){var a=_.map(t,function(t){return t.query}),r=o(e,i,C,c,a);q.push(n.values("cooccurrence",{format:"json"},r).then(function(e){e.data["values-response"]&&(C.length>1?angular.forEach(e.data["values-response"].tuple,function(e){var n=e["distinct-value"],i={xCategory:v(_.without([n[m.values.xCategoryAxisIndex],t[m.facets.xCategoryAxisIndex]],null,void 0)[0]),x:v(_.without([n[m.values.xAxisIndex],t[m.facets.xAxisIndex]],null,void 0)[0]),y:v(_.without([n[m.values.yAxisIndex],t[m.facets.yAxisIndex]],null,void 0)[0]),z:v(_.without([n[m.values.zAxisIndex],t[m.facets.zAxisIndex]],null,void 0)[0])};i.xCategory&&x.indexOf(i.xCategory)<0&&x.push(i.xCategory),i.name=_.without([i.xCategory,i.x,i.y,i.z],null,void 0).join(),i[m.frequency]=e.frequency,i.frequency=e.frequency,f.push(i)}):angular.forEach(e.data["values-response"]["distinct-value"],function(e){var n={xCategory:v(_.without([m.values.xCategoryAxisIndex>-1?e:null,t[m.facets.xCategoryAxisIndex]],null,void 0)[0]),x:v(_.without([m.values.xAxisIndex>-1?e:null,t[m.facets.xAxisIndex]],null,void 0)[0]),y:v(_.without([m.values.yAxisIndex>-1?e:null,t[m.facets.yAxisIndex]],null,void 0)[0]),z:v(_.without([m.values.zAxisIndex>-1?e:null,t[m.facets.zAxisIndex]],null,void 0)[0])};n.xCategory&&x.indexOf(n.xCategory)<0&&x.push(n.xCategory),n.name=_.without([n.xCategory,n.x,n.y,n.z],null,void 0).join(),n[m.frequency]=e.frequency,n.frequency=e.frequency,f.push(n)}))}))}),t.all(q).then(function(){return{data:f.sort(function(t,e){return e.frequency-t.frequency}),categories:x}})}1===y.length?angular.forEach(d,function(t){var e={xCategory:v(_.without([t[m.facets.xCategoryAxisIndex]],null,void 0)),x:v(_.without([t[m.facets.xAxisIndex]],null,void 0)),y:v(_.without([t[m.facets.yAxisIndex]],null,void 0)),z:v(_.without([t[m.facets.zAxisIndex]],null,void 0)),frequency:t[0].frequency};e[m.frequency]=t[0].frequency,f.push(e)}):console.log("TODO: mulitple bucket facets without values")}return{data:f.sort(function(t,e){return e.frequency-t.frequency}),categories:x}})},u.chartTypes=function(){return["line","spline","area","areaspline","column","bar","bubble","pie","scatter"]},u}])}(),function(){"use strict";angular.module("ml.highcharts").controller("EditChartConfigCtrl",["$modalInstance","$scope","HighchartsHelper","facets","highchartConfig","MLSearchFactory",function(t,e,n,i,a,r){e.facetSortOptions={},e.xSortOptions={accept:function(t,e){return e.modelValue.length<1}},e.chartFacetOptions=Object.keys(i);var o=e.chartFacetOptions[0];e.chartFacetOptions.splice(0,1),e.facets=i,e.highchartConfig=a||{options:{chart:{type:"bar"},tooltip:{style:{padding:10,fontWeight:"bold"}}},title:{text:"Title"},xAxis:{title:{text:o}},xAxisMLConstraint:o,xAxisCategoriesMLConstraint:null,yAxis:{title:{text:null}},yAxisMLConstraint:"$frequency",zAxis:{title:{text:null}},zAxisMLConstraint:null,size:{height:250},resultLimit:15},e.highchartConfig.xAxis||(e.highchartConfig.xAxis={title:{text:null}}),e.highchartConfig.yAxis||(e.highchartConfig.yAxis={title:{text:null}}),e.xAxisMLConstraint=_.without([e.highchartConfig.xAxisMLConstraint],null,void 0),e.xAxisCategoriesMLConstraint=_.without([e.highchartConfig.xAxisCategoriesMLConstraint],null,void 0),e.yAxisMLConstraint=_.without([e.highchartConfig.yAxisMLConstraint],null,void 0),e.zAxisMLConstraint=_.without([e.highchartConfig.zAxisMLConstraint],null,void 0);var s=function(){e.previewHighChart=n.chartFromConfig(e.highchartConfig)};e.chartTypes=n.chartTypes(),s(),e.$watch(function(){return e.highchartConfig.options.chart.type+e.highchartConfig.xAxis.title.text+e.highchartConfig.yAxis.title.text+e.highchartConfig.title.text+e.highchartConfig.resultLimit},function(){s()}),e.$watch(function(){return e.xAxisMLConstraint.length+""+e.yAxisMLConstraint.length+e.xAxisCategoriesMLConstraint.length},function(){e.highchartConfig.xAxisMLConstraint=e.xAxisMLConstraint[0],e.highchartConfig.yAxisMLConstraint=e.yAxisMLConstraint[0],e.highchartConfig.zAxisMLConstraint=e.zAxisMLConstraint[0],e.highchartConfig.xAxisCategoriesMLConstraint=e.xAxisCategoriesMLConstraint[0],s()}),e.save=function(){t.close(e.highchartConfig)}}]).factory("EditChartConfigDialog",["$modal",function(t){return function(e,n){return t.open({templateUrl:"/ml-highcharts/templates/ml-highchart-config-modal.html",controller:"EditChartConfigCtrl",size:"lg",resolve:{facets:function(){return e},highchartConfig:function(){return n}}}).result}}])}(),function(){"use strict";angular.module("ml.highcharts").directive("mlHighchart",["$q","HighchartsHelper","MLRest","MLSearchFactory",function(t,e,n,i){function a(t,n,a){t.mlSearch||(t.mlSearch=i.newContext());var r=function(){t.highchartConfig&&(t.populatedConfig=e.chartFromConfig(t.highchartConfig,t.mlSearch,t.mlSearchController,t.callback))},o=function(t){return function(){var e=t.apply(this,arguments);return e&&angular.isFunction(e.then)?e.then(function(t){return r(),t}):(r(),e)}},s=t.mlSearch.search;t.mlSearch.search=o(s),r()}return{restrict:"E",templateUrl:"/ml-highcharts/templates/ml-highchart.html",scope:{mlSearch:"=",highchartConfig:"=",callback:"&"},link:a}}])}();
!function(){"use strict";angular.module("ml.highcharts",["highcharts-ng","ml.common","ml.highcharts.tpls","ml.search","ui.bootstrap"])}(),function(){"use strict";angular.module("ml.highcharts").factory("HighchartsHelper",["$q","MLQueryBuilder","MLRest","MLSearchFactory",function(t,e,n,a){function i(t,e,n){var a={xCategoryAxis:t.xAxisCategoriesMLConstraint,xAxis:t.xAxisMLConstraint,yAxis:t.yAxisMLConstraint,zAxis:t.zAxisMLConstraint,seriesName:t.seriesNameMLConstraint,dataPointName:t.dataPointNameMLConstraint,xCategoryAxisAggregate:t.xAxisCategoriesMLConstraintAggregate,xAxisAggregate:t.xAxisMLConstraintAggregate,yAxisAggregate:t.yAxisMLConstraintAggregate,zAxisAggregate:t.zAxisMLConstraintAggregate};a.aggregates={},angular.forEach(a,function(t,e){t&&a[e+"Aggregate"]&&(a.aggregates[t]||(a.aggregates[t]=[]),a.aggregates[t].push({type:a[e+"Aggregate"],axis:e.substring(0,e.indexOf("Axis"))}))});var i=_.map(a.aggregates,function(t,e){return e});return n=_.filter(n,function(t){return i.indexOf(t)<0}),"$frequency"===t.xAxisCategoriesMLConstraint?a.frequency="xCategory":"$frequency"===t.xAxisMLConstraint?a.frequency="x":"$frequency"===t.yAxisMLConstraint?a.frequency="y":"$frequency"===t.zAxisMLConstraint&&(a.frequency="z"),a.facets={xCategoryAxisIndex:e.indexOf(a.xCategoryAxis),xAxisIndex:e.indexOf(a.xAxis),yAxisIndex:e.indexOf(a.yAxis),zAxisIndex:e.indexOf(a.zAxis),seriesNameIndex:e.indexOf(a.seriesName),dataPointNameIndex:e.indexOf(a.dataPointName)},a.values={xCategoryAxisIndex:n.indexOf(a.xCategoryAxis),xAxisIndex:n.indexOf(a.xAxis),yAxisIndex:n.indexOf(a.yAxis),zAxisIndex:n.indexOf(a.zAxis),seriesNameIndex:n.indexOf(a.seriesName),dataPointNameIndex:n.indexOf(a.dataPointName)},a}function r(t,e){return _.filter(t,function(t){return t&&t.name&&e.indexOf(t.name)>-1}).sort(function(t,n){var a=t.collection?1:100,i=n.collection?1:100;return e.indexOf(t.name)*a-e.indexOf(n.name)*i})}function s(t,e,n,a,i){var r=_.map(n,function(t){return t.range}),s=_.map(n,function(t){return t.collection}),o=[{name:"cooccurrence",collection:_.without(s,null,void 0),range:_.without(r,null,void 0),"values-option":["frequency-order","limit="+(a?a:"20")]}],u=t?angular.copy(t.getQuery().query):{queries:[]};i&&i.length&&u.queries.unshift.apply(u.queries,i);var c={search:{options:{constraint:e},query:u}};return n.length>1?c.search.options.tuples=o:1==n.length&&(c.search.options.values=o),c}function o(t){if(1===t.length)return _.map(t[0].facetValues,function(e){return[{facetName:t[0].name,type:t[0].type,_value:e.value,frequency:e.frequency||e.count,query:{qtext:'"'+t[0].name+'":"'+e.name+'"'}}]});for(var e=[],n=o(t.slice(1)),a=0;a<n.length;a++)for(var i=0;i<t[0].facetValues.length;i++)e.push(_.flatten([{facetName:t[0].name,type:t[0].type,_value:t[0].facetValues[i].value,frequecy:t[0].facetValues[i].frequency,query:u(t[0].name,t[0].facetValues[i].name)},n[a]]));return e}function u(t,e){return{qtext:'"'+t+'":"'+e+'"'}}var c={};return c.seriesData=function(t,e,n){var a=[{name:null,data:[]}];return angular.forEach(t,function(t){var e;t.seriesName?(e=_.filter(a,function(e){return e.name===t.seriesName})[0],e||(e={name:t.seriesName,data:[]},a.push(e))):e=a[0],n.length?angular.forEach(n,function(n,i){n===t.xCategory&&(e=_.filter(a,function(e){var n=!0;return t.seriesName&&(n=e.name===t.seriesName),!e.data[i]&&n})[0],e||(e={name:t.seriesName,data:[]},a.push(e)),e.data[i]=t)}):e.data.push(t)}),n.length&&angular.forEach(a,function(t){angular.forEach(n,function(e,n){t.data[n]||(t.data[n]={name:null,x:0,y:0,z:0})})}),a},c.chartFromConfig=function(e,n,i){var r=t.defer(),s=e.options.chart.type,o=angular.copy(e);return n||(n=a.newContext()),i&&(o.options.plotOptions={series:{cursor:"pointer",point:{events:{click:function(){var t=this.name||this.seriesName;i(angular.extend({facet:this.facetNames[0],value:t},this))}}}}}),n.getStoredOptions(n.options.queryOptions).then(function(t){t.options&&t.options.constraint&&t.options.constraint.length&&c.getChartData(n,t.options.constraint,e,e.resultLimit).then(function(t){o.series=c.seriesData(t.data,s,t.categories),t.categories&&t.categories.length&&(o.xAxis.categories=t.categories),r.resolve(o)})}),r.promise},c.getChartData=function(e,a,l,g){var h,x=_.without([l.seriesNameMLConstraint,l.dataPointNameMLConstraint,l.xAxisCategoriesMLConstraint,l.xAxisMLConstraint,l.yAxisMLConstraint,l.zAxisMLConstraint],null,void 0,"$frequency"),f=[],m=[];if(e.results.facets){var d=angular.copy(e.results.facets);angular.forEach(d,function(t,e){t.name=e}),h=t.when(d)}else h=n.search({options:e.options.queryOptions}).then(function(t){return angular.forEach(t.data.facets,function(t,e){t.name=e}),t.data.facets});return h.then(function(h){if(a&&a.length){var d=r(a,x),C=[],y=[];angular.forEach(d,function(t){t.custom||t.range&&(t.range.bucket||t.range["computed-bucket"])?C.push(h[t.name]):y.push(t)});var A,p=_.map(y,function(t){return t.name}),v=_.map(C,function(t){return t.name}),L=i(l,v,p),M=function(t){return t?t._value:void 0};if(A=C.length>0?o(C):[[]],y.length>0){var N=[],q=_.filter(y,function(t){return!L.aggregates[t.name]}),I=_.filter(y,function(t){return L.aggregates[t.name]});return angular.forEach(A,function(t){var n=_.map(t,function(t){return t.query});q.length>0&&N.push(c.constraintValueCall(e,a,q,g,n).then(function(e){e["values-response"]&&(q.length>1?angular.forEach(e["values-response"].tuple,function(e){var n=e["distinct-value"],a={facetNames:x,seriesName:M(_.without([n[L.values.seriesNameIndex],t[L.facets.seriesNameIndex]],null,void 0)[0]),name:M(_.without([n[L.values.dataPointNameIndex],t[L.facets.dataPointNameIndex]],null,void 0)[0]),xCategory:M(_.without([n[L.values.xCategoryAxisIndex],t[L.facets.xCategoryAxisIndex]],null,void 0)[0]),x:M(_.without([n[L.values.xAxisIndex],t[L.facets.xAxisIndex]],null,void 0)[0]),y:M(_.without([n[L.values.yAxisIndex],t[L.facets.yAxisIndex]],null,void 0)[0]),z:M(_.without([n[L.values.zAxisIndex],t[L.facets.zAxisIndex]],null,void 0)[0])};a.xCategory&&f.indexOf(a.xCategory)<0&&f.push(a.xCategory),a.name||(a.name=_.without([a.seriesName,a.xCategory,a.x,a.y,a.z],null,void 0).join()),a[L.frequency]=e.frequency,a.frequency=e.frequency,m.push(a)}):angular.forEach(e["values-response"]["distinct-value"],function(e){var n={facetNames:x,seriesName:M(_.without([L.values.seriesNameIndex>-1?e:null,t[L.facets.seriesNameIndex]],null,void 0)[0]),name:M(_.without([L.values.dataPointNameIndex>-1?e:null,t[L.facets.dataPointNameIndex]],null,void 0)[0]),xCategory:M(_.without([L.values.xCategoryAxisIndex>-1?e:null,t[L.facets.xCategoryAxisIndex]],null,void 0)[0]),x:M(_.without([L.values.xAxisIndex>-1?e:null,t[L.facets.xAxisIndex]],null,void 0)[0]),y:M(_.without([L.values.yAxisIndex>-1?e:null,t[L.facets.yAxisIndex]],null,void 0)[0]),z:M(_.without([L.values.zAxisIndex>-1?e:null,t[L.facets.zAxisIndex]],null,void 0)[0])};n.xCategory&&f.indexOf(n.xCategory)<0&&f.push(n.xCategory),n.name||(n.name=_.without([n.xCategory,n.x,n.y,n.z],null,void 0).join()),n[L.frequency]=e.frequency,n.frequency=e.frequency,m.push(n)}))}))}),t.all(N).then(function(){var n=[];return angular.forEach(I,function(t){angular.forEach(L.aggregates[t.name],function(i){angular.forEach(m,function(r){var s=_.without(_.map(r,function(t,e){var n=L[e+"Axis"];return"name"===e?n=L.dataPointName:"seriesName"===e&&(n=L.seriesName),t&&n&&"$frequency"!==n?u(n,t):null}),null,void 0);n.push(c.constraintValueCall(e,a,[t],g,s,i.type).then(function(t){r[i.axis]=Number(t["values-response"]["aggregate-result"][0]._value)}))})})}),t.all(n).then(function(){return{data:m.sort(function(t,e){return e.frequency-t.frequency}),categories:f}})})}var z=[];return angular.forEach(A,function(t,i){var r={facetNames:x,seriesName:M(t[L.facets.seriesNameIndex]),name:M(t[L.facets.dataPointNameIndex]),xCategory:M(t[L.facets.xCategoryAxisIndex]),x:M(t[L.facets.xAxisIndex]),y:M(t[L.facets.yAxisIndex]),z:M(t[L.facets.zAxisIndex])};if(1===C.length)r.frequency=t[0].frequency||t[0].count,r[L.frequency]=r.frequency;else{var o=_.map(t,function(t){return t.query}),u=s(e,a,[],g,o);u.search.options["return-results"]=!1,u.search.options["return-facets"]=!1,u.search.options["return-values"]=!1,u.search.options["return-metrics"]=!0,z.push(n.search({options:e.options.queryOptions},u).then(function(t){var e=t.data.total;r.frequency=e,r[L.frequency]=e}))}m.push(r)}),t.all(z).then(function(){return{data:m.sort(function(t,e){return e.frequency-t.frequency}),categories:f}})}})},c.constraintValueCall=function(t,e,a,i,r,o){var u=s(t,e,a,i,r);return n.values("cooccurrence",{format:"json",aggregate:o,view:o?"aggregate":"all"},u).then(function(t){return t.data})},c.chartTypes=function(){return["line","spline","area","areaspline","column","bar","bubble","pie","scatter"]},c.aggregateTypes=function(){return[null,"sum","avg","min","max","median","count","stddev","stddev-population","correlation","covariance","covariance-population","variance","variance-population"]},c}])}(),function(){"use strict";angular.module("ml.highcharts").controller("EditChartConfigCtrl",["$modalInstance","$scope","HighchartsHelper","facets","highchartConfig","mlSearch",function(t,e,n,a,i,r){e.facetSortOptions={clone:!0,accept:function(t,e){return!0},allowDuplicates:!1},e.xSortOptions={accept:function(t,e){return e.modelValue&&e.modelValue.length<1}},e.mlSearch=r,e.chartFacetOptions=Object.keys(a);var s=e.chartFacetOptions[0];e.chartFacetOptions.push("$frequency"),e.aggregateTypes=n.aggregateTypes(),e.facets=a,e.highchartConfig=i||{options:{chart:{type:"bar"},tooltip:{style:{padding:10,fontWeight:"bold"}}},title:{text:"Title"},xAxis:{title:{text:s}},seriesNameMLConstraint:s,dataPointNameMLConstraint:null,xAxisMLConstraint:null,xAxisMLConstraintAggregate:null,xAxisCategoriesMLConstraint:null,xAxisCategoriesMLConstraintAggregate:null,yAxis:{title:{text:null}},yAxisMLConstraint:"$frequency",yAxisMLConstraintAggregate:null,zAxis:{title:{text:null}},zAxisMLConstraint:null,zAxisMLConstraintAggregate:null,size:{height:250},resultLimit:15},e.highchartConfig.xAxis||(e.highchartConfig.xAxis={title:{text:null}}),e.highchartConfig.yAxis||(e.highchartConfig.yAxis={title:{text:null}}),e.dataPointNameMLConstraint=_.without([e.highchartConfig.dataPointNameMLConstraint],null,void 0),e.seriesNameMLConstraint=_.without([e.highchartConfig.seriesNameMLConstraint],null,void 0),e.xAxisMLConstraint=_.without([e.highchartConfig.xAxisMLConstraint],null,void 0),e.xAxisCategoriesMLConstraint=_.without([e.highchartConfig.xAxisCategoriesMLConstraint],null,void 0),e.yAxisMLConstraint=_.without([e.highchartConfig.yAxisMLConstraint],null,void 0),e.zAxisMLConstraint=_.without([e.highchartConfig.zAxisMLConstraint],null,void 0);var o=function(){e.mlSearch.search()};e.chartTypes=n.chartTypes(),o(),e.$watch(function(){return e.highchartConfig.options.chart.type+e.highchartConfig.xAxis.title.text+e.highchartConfig.yAxis.title.text+e.highchartConfig.title.text+e.highchartConfig.resultLimit},function(){o()}),e.$watch(function(){return e.xAxisMLConstraint.length+""+e.yAxisMLConstraint.length+e.zAxisMLConstraint.length+e.xAxisCategoriesMLConstraint.length+e.seriesNameMLConstraint.length+e.dataPointNameMLConstraint.length+e.highchartConfig.xAxisMLConstraintAggregate+e.highchartConfig.yAxisMLConstraintAggregate+e.highchartConfig.zAxisMLConstraintAggregate},function(){e.highchartConfig.seriesNameMLConstraint=e.seriesNameMLConstraint[0],e.highchartConfig.dataPointNameMLConstraint=e.dataPointNameMLConstraint[0],e.highchartConfig.xAxisMLConstraint=e.xAxisMLConstraint[0],e.highchartConfig.yAxisMLConstraint=e.yAxisMLConstraint[0],e.highchartConfig.zAxisMLConstraint=e.zAxisMLConstraint[0],e.highchartConfig.xAxisCategoriesMLConstraint=e.xAxisCategoriesMLConstraint[0],o()}),e.save=function(){t.close(e.highchartConfig)}}]).factory("EditChartConfigDialog",["$modal","MLSearchFactory",function(t,e){return function(n,a,i){return t.open({templateUrl:"/ml-highcharts/templates/ml-highchart-config-modal.html",controller:"EditChartConfigCtrl",size:"lg",resolve:{facets:function(){return n},highchartConfig:function(){return a},mlSearch:function(){return e.newContext({queryOptions:i||"all"})}}}).result}}])}(),function(){"use strict";angular.module("ml.highcharts").directive("mlHighchart",["$q","HighchartsHelper","MLRest","MLSearchFactory",function(t,e,n,a){function i(t,n,i){t.mlSearch||(t.mlSearch=a.newContext());var r=function(){t.highchartConfig&&e.chartFromConfig(t.highchartConfig,t.mlSearch,t.callback).then(function(e){t.populatedConfig=e})},s=function(t){return function(){var e=t.apply(this,arguments);return e&&angular.isFunction(e.then)?e.then(function(t){return r(),t}):(r(),e)}},o=t.mlSearch.search;t.mlSearch.search=s(o),r()}return{restrict:"E",templateUrl:"/ml-highcharts/templates/ml-highchart.html",scope:{mlSearch:"=",highchartConfig:"=",callback:"&"},link:i}}])}();
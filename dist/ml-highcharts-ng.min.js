!function(){"use strict";angular.module("ml.highcharts",["ml.common","ml.search"])}(),function(){"use strict";angular.module("ml.highcharts").directive("mlHighchart",["$q","HighchartsHelper","MLRest","MLSearchFactory",function(e,n,a,t){function r(e,a,r){e.mlSearch=e.mlSearch||t.newContext();var i=function(){e.highchartConfig&&(e.populatedConfig=n.chartFromConfig(e.highchartConfig,e.mlSearch,e.callback))};e.$watchCollection("mlSearch.getQuery()",i)}return{restrict:"E",templateUrl:"/ml-highcharts/templates/ml-highchart.html",scope:{mlSearch:"=",highchartConfig:"=",callback:"&"},link:r}}])}(),function(){"use strict";angular.module("ml.highcharts").factory("HighchartsHelper",["$q","MLRest","MLSearchFactory",function(e,n,a){var t={};return t.seriesData=function(e,n,a){var t=[];return t=a.length?_.map(e,function(e){var t=[],r=a.indexOf(e.xCategory);return angular.forEach(a,function(n,a){t[a]=a===r?[n,e.y]:[n,0]}),{type:n,name:e.x,data:t}}):"pie"===n?[{type:n,data:e}]:_.map(e,function(e){return{type:n,name:e.x,data:[e.y]}})},t.chartFromConfig=function(e,n,r){var i=e.options.chart.type,o=angular.copy(e);return n=n||a.newContext(),n.getStoredOptions("all").then(function(a){if(a.options&&a.options.constraint){var r=_.filter(a.options.constraint,function(e){var n=e.range||e.collection;return n&&n.facet});t.getChartData(n,r,e,e.facetLimit).then(function(e){o.series=t.seriesData(e.data,i,e.categories),e.categories&&e.categories.length&&(o.xAxis.categories=e.categories)})}}),r&&(o.options.plotOptions={series:{cursor:"pointer",point:{events:{click:function(){var e=this.name||this.series.name;r(1===e.data.length?{facet:e.data[0].__key,value:e}:{facet:this.series.name,value:e})}}}}}),o},t.getChartData=function(a,t,r,i){var o=[r.xAxisCategoriesMapping,r.xAxisMapping,r.yAxisMapping],s={xCategoryAxis:r.xAxisCategoriesMapping,xAxis:r.xAxisMapping,yAxis:r.yAxisMapping},c=[];if("$frequency"===r.xAxisCategoriesMapping?s.frequecy="xCategory":"$frequency"===r.xAxisMapping?s.frequecy="x":"$frequency"===r.yAxisMapping&&(s.frequecy="y"),t&&t.length){var u=_.filter(t,function(e){return e&&e.name&&o.indexOf(e.name)>-1&&e.range}).sort(function(e,n){return o.indexOf(e.name)-o.indexOf(n.name)}),l=_.map(u,function(e){return e.range}),x=_.map(u,function(e){return e.name});s.xCategoryAxisIndex=x.indexOf(s.xCategoryAxis),s.xAxisIndex=x.indexOf(s.xAxis),s.yAxisIndex=x.indexOf(s.yAxis);var g=[{name:"cooccurrence",range:l,"values-option":["frequency-order","limit="+(i?i:"20")]}],h={search:{options:{constraint:t},query:a?a.getQuery().query:{queries:[]}}};return u.length>1?h.search.options.tuples=g:h.search.options.values=g,n.values("cooccurrence",{format:"json"},h).then(function(e){var n=[];return e.data["values-response"]&&(u.length>1?angular.forEach(e.data["values-response"].tuple,function(e){var a=e["distinct-value"],t={xCategory:a[s.xCategoryAxisIndex]?a[s.xCategoryAxisIndex]._value:null,x:a[s.xAxisIndex]?a[s.xAxisIndex]._value:null,y:a[s.yAxisIndex]?a[s.yAxisIndex]._value:null};t.xCategory&&c.indexOf(t.xCategory)<0&&c.push(t.xCategory),t.name=t.xCategory||t.x||t.y,t[s.frequecy]=e.frequency,n.push(t)}):angular.forEach(e.data["values-response"]["distinct-value"],function(e){var a={x:s.xAxisIndex>-1?e._value:null,y:s.yAxisIndex>-1?e._value:null};a.name=a.x||a.y,a[s.frequecy]=e.frequency,n.push(a)})),{data:n,categories:c}})}var f=e.defer();return f.resolve(null),f.promise},t.chartTypes=function(){return["line","spline","area","areaspline","column","bar","pie","scatter"]},t}])}();
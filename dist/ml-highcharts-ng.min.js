!function(){"use strict";angular.module("ml.highcharts",["highcharts-ng","ml.common","ml.highcharts.tpls","ml.search","ui.bootstrap"])}(),function(){"use strict";angular.module("ml.highcharts").directive("mlHighchart",["$q","HighchartsHelper","MLRest","MLSearchFactory",function(t,e,n,a){function i(t,n,i){t.mlSearch||(t.mlSearch=a.newContext());var r=function(){t.highchartConfig&&e.chartFromConfig(t.highchartConfig,t.mlSearch,t.callback).then(function(e){t.populatedConfig=e})},s=function(t){return function(){var e=t.apply(this,arguments);return e&&angular.isFunction(e.then)?e.then(function(t){return r(),t}):(r(),e)}},o=t.mlSearch.search;t.mlSearch.search=s(o),r()}return{restrict:"E",templateUrl:"/ml-highcharts/templates/ml-highchart.html",scope:{mlSearch:"=",highchartConfig:"=",callback:"&"},link:i}}])}(),function(){"use strict";angular.module("ml.highcharts").controller("EditChartConfigCtrl",["$modalInstance","$scope","HighchartsHelper","facets","highchartConfig","MLSearchFactory",function(t,e,n,a,i,r){e.facetSortOptions={},e.xSortOptions={accept:function(t,e){return e.modelValue&&e.modelValue.length<1}},e.chartFacetOptions=Object.keys(a);var s=e.chartFacetOptions[0];i?(e.chartFacetOptions.push("$frequency"),e.chartFacetOptions=_.without(e.chartFacetOptions,i.seriesNameMLConstraint,i.dataPointNameMLConstraint,i.xAxisMLConstraint,i.xAxisCategoriesMLConstraint,i.yAxisMLConstraint,i.zAxisMLConstraint)):e.chartFacetOptions.splice(0,1),e.aggregateTypes=n.aggregateTypes(),e.facets=a,e.highchartConfig=i||{options:{chart:{type:"bar"},tooltip:{style:{padding:10,fontWeight:"bold"}}},title:{text:"Title"},xAxis:{title:{text:s}},seriesNameMLConstraint:null,dataPointNameMLConstraint:null,xAxisMLConstraint:s,xAxisMLConstraintAggregate:null,xAxisCategoriesMLConstraint:null,xAxisCategoriesMLConstraintAggregate:null,yAxis:{title:{text:null}},yAxisMLConstraint:"$frequency",yAxisMLConstraintAggregate:null,zAxis:{title:{text:null}},zAxisMLConstraint:null,zAxisMLConstraintAggregate:null,size:{height:250},resultLimit:15},e.highchartConfig.xAxis||(e.highchartConfig.xAxis={title:{text:null}}),e.highchartConfig.yAxis||(e.highchartConfig.yAxis={title:{text:null}}),e.dataPointNameMLConstraint=_.without([e.highchartConfig.dataPointNameMLConstraint],null,void 0),e.seriesNameMLConstraint=_.without([e.highchartConfig.seriesNameMLConstraint],null,void 0),e.xAxisMLConstraint=_.without([e.highchartConfig.xAxisMLConstraint],null,void 0),e.xAxisCategoriesMLConstraint=_.without([e.highchartConfig.xAxisCategoriesMLConstraint],null,void 0),e.yAxisMLConstraint=_.without([e.highchartConfig.yAxisMLConstraint],null,void 0),e.zAxisMLConstraint=_.without([e.highchartConfig.zAxisMLConstraint],null,void 0);var o=function(){e.previewHighChart=n.chartFromConfig(e.highchartConfig)};e.chartTypes=n.chartTypes(),o(),e.$watch(function(){return e.highchartConfig.options.chart.type+e.highchartConfig.xAxis.title.text+e.highchartConfig.yAxis.title.text+e.highchartConfig.title.text+e.highchartConfig.resultLimit},function(){o()}),e.$watch(function(){return e.xAxisMLConstraint.length+""+e.yAxisMLConstraint.length+e.zAxisMLConstraint.length+e.xAxisCategoriesMLConstraint.length+e.seriesNameMLConstraint.length+e.dataPointNameMLConstraint.length+e.highchartConfig.xAxisMLConstraintAggregate+e.highchartConfig.yAxisMLConstraintAggregate+e.highchartConfig.zAxisMLConstraintAggregate},function(){e.highchartConfig.seriesNameMLConstraint=e.seriesNameMLConstraint[0],e.highchartConfig.dataPointNameMLConstraint=e.dataPointNameMLConstraint[0],e.highchartConfig.xAxisMLConstraint=e.xAxisMLConstraint[0],e.highchartConfig.yAxisMLConstraint=e.yAxisMLConstraint[0],e.highchartConfig.zAxisMLConstraint=e.zAxisMLConstraint[0],e.highchartConfig.xAxisCategoriesMLConstraint=e.xAxisCategoriesMLConstraint[0],o()}),e.save=function(){t.close(e.highchartConfig)}}]).factory("EditChartConfigDialog",["$modal",function(t){return function(e,n){return t.open({templateUrl:"/ml-highcharts/templates/ml-highchart-config-modal.html",controller:"EditChartConfigCtrl",size:"lg",resolve:{facets:function(){return e},highchartConfig:function(){return n}}}).result}}])}(),function(){"use strict";angular.module("ml.highcharts").factory("HighchartsHelper",["$q","MLQueryBuilder","MLRest","MLSearchFactory",function(t,e,n,a){function i(t,e,n){var a={xCategoryAxis:t.xAxisCategoriesMLConstraint,xAxis:t.xAxisMLConstraint,yAxis:t.yAxisMLConstraint,zAxis:t.zAxisMLConstraint,seriesName:t.seriesNameMLConstraint,dataPointName:t.dataPointNameMLConstraint,xCategoryAxisAggregate:t.xAxisCategoriesMLConstraintAggregate,xAxisAggregate:t.xAxisMLConstraintAggregate,yAxisAggregate:t.yAxisMLConstraintAggregate,zAxisAggregate:t.zAxisMLConstraintAggregate};a.aggregates={},angular.forEach(a,function(t,e){t&&a[e+"Aggregate"]&&(a.aggregates[t]||(a.aggregates[t]=[]),a.aggregates[t].push({type:a[e+"Aggregate"],axis:e.substring(0,e.indexOf("Axis"))}))});var i=_.map(a.aggregates,function(t,e){return e});return n=_.filter(n,function(t){return i.indexOf(t)<0}),"$frequency"===t.xAxisCategoriesMLConstraint?a.frequency="xCategory":"$frequency"===t.xAxisMLConstraint?a.frequency="x":"$frequency"===t.yAxisMLConstraint?a.frequency="y":"$frequency"===t.zAxisMLConstraint&&(a.frequency="z"),a.facets={xCategoryAxisIndex:e.indexOf(a.xCategoryAxis),xAxisIndex:e.indexOf(a.xAxis),yAxisIndex:e.indexOf(a.yAxis),zAxisIndex:e.indexOf(a.zAxis),seriesNameIndex:e.indexOf(a.seriesName),dataPointNameIndex:e.indexOf(a.dataPointName)},a.values={xCategoryAxisIndex:n.indexOf(a.xCategoryAxis),xAxisIndex:n.indexOf(a.xAxis),yAxisIndex:n.indexOf(a.yAxis),zAxisIndex:n.indexOf(a.zAxis),seriesNameIndex:n.indexOf(a.seriesName),dataPointNameIndex:n.indexOf(a.dataPointName)},a}function r(t,e){return _.filter(t,function(t){return t&&t.name&&e.indexOf(t.name)>-1&&t.range}).sort(function(t,n){var a=t.collection?1:100,i=n.collection?1:100;return e.indexOf(t.name)*a-e.indexOf(n.name)*i})}function s(t,e,n,a,i){var r=_.map(n,function(t){return t.range}),s=_.map(n,function(t){return t.collection}),o=[{name:"cooccurrence",collection:_.without(s,null,void 0),range:_.without(r,null,void 0),"values-option":["frequency-order","limit="+(a?a:"20")]}],u=t?angular.copy(t.getQuery().query):{queries:[]};i&&i.length&&u.queries.unshift.apply(u.queries,i);var c={search:{options:{constraint:e},query:u}};return n.length>1?c.search.options.tuples=o:c.search.options.values=o,c}function o(t){if(1===t.length)return _.map(t[0].facetValues,function(e){return[{facetName:t[0].name,type:t[0].type,_value:e.value,frequecy:e.frequency,query:{qtext:'"'+t[0].name+'":"'+e.name+'"'}}]});for(var e=[],n=o(t.slice(1)),a=0;a<n.length;a++)for(var i=0;i<t[0].facetValues.length;i++)e.push(_.flatten([{facetName:t[0].name,type:t[0].type,_value:t[0].facetValues[i].value,frequecy:t[0].facetValues[i].frequency,query:u(t[0].name,t[0].facetValues[i].name)},n[a]]));return e}function u(t,e){return{qtext:'"'+t+'":"'+e+'"'}}var c={};return c.seriesData=function(t,e,n){var a=[{name:null,data:[]}];return angular.forEach(t,function(t){var e;t.seriesName?(e=_.filter(a,function(e){return e.name===t.seriesName})[0],e||(e={name:t.seriesName,data:[]},a.push(e))):e=a[0],n.length?angular.forEach(n,function(n,i){n===t.xCategory&&(e=_.filter(a,function(e){var n=!0;return t.seriesName&&(n=e.name===t.seriesName),!e.data[i]&&n})[0],e||(e={name:t.seriesName,data:[]},a.push(e)),e.data[i]=t)}):e.data.push(t)}),n.length&&angular.forEach(a,function(t){angular.forEach(n,function(e,n){t.data[n]||(t.data[n]={name:null,x:0,y:0,z:0})})}),a},c.chartFromConfig=function(e,n,i){var r=t.defer(),s=e.options.chart.type,o=angular.copy(e);return n||(n=a.newContext()),i&&(o.options.plotOptions={series:{cursor:"pointer",point:{events:{click:function(){var t=this.name||this.series.name;i(t.data&&1===t.data.length?{facet:t.data[0].__key,value:t}:{facet:this.series.name,value:t})}}}}}),n.getStoredOptions("all").then(function(t){if(t.options&&t.options.constraint){var a=_.filter(t.options.constraint,function(t){var e=t.range||t.collection;return e});c.getChartData(n,a,e,e.resultLimit).then(function(t){o.series=c.seriesData(t.data,s,t.categories),t.categories&&t.categories.length&&(o.xAxis.categories=t.categories),r.resolve(o)})}}),r.promise},c.getChartData=function(e,a,s,l){var g,h=_.without([s.seriesNameMLConstraint,s.dataPointNameMLConstraint,s.xAxisCategoriesMLConstraint,s.xAxisMLConstraint,s.yAxisMLConstraint,s.zAxisMLConstraint],null,void 0),x=[],f=[];if(e.results.facets){var C=angular.copy(e.results.facets);angular.forEach(C,function(t,e){t.name=e}),g=t.when(C)}else g=n.search({options:e.options.queryOptions}).then(function(t){return angular.forEach(t.data.facets,function(t,e){t.name=e}),t.data.facets});return g.then(function(n){if(a&&a.length){var g=r(a,h),C=[],d=[];angular.forEach(g,function(t){t.custom||t.range&&(t.range.bucket||t.range["computed-bucket"])?C.push(n[t.name]):d.push(t)});var m,y=_.map(d,function(t){return t.name}),A=_.map(C,function(t){return t.name}),p=i(s,A,y),v=function(t){return t?t._value:void 0};if(m=C.length>0?o(C):[[]],d.length>0){var L=[],M=_.filter(d,function(t){return!p.aggregates[t.name]}),N=_.filter(d,function(t){return p.aggregates[t.name]});return angular.forEach(m,function(t){var n=_.map(t,function(t){return t.query});M.length>0&&L.push(c.constraintValueCall(e,a,M,l,n).then(function(e){e["values-response"]&&(M.length>1?angular.forEach(e["values-response"].tuple,function(e){var n=e["distinct-value"],a={seriesName:v(_.without([n[p.values.seriesNameIndex],t[p.facets.seriesNameIndex]],null,void 0)[0]),name:v(_.without([n[p.values.dataPointNameIndex],t[p.facets.dataPointNameIndex]],null,void 0)[0]),xCategory:v(_.without([n[p.values.xCategoryAxisIndex],t[p.facets.xCategoryAxisIndex]],null,void 0)[0]),x:v(_.without([n[p.values.xAxisIndex],t[p.facets.xAxisIndex]],null,void 0)[0]),y:v(_.without([n[p.values.yAxisIndex],t[p.facets.yAxisIndex]],null,void 0)[0]),z:v(_.without([n[p.values.zAxisIndex],t[p.facets.zAxisIndex]],null,void 0)[0])};a.xCategory&&x.indexOf(a.xCategory)<0&&x.push(a.xCategory),a.name||(a.name=_.without([a.seriesName,a.xCategory,a.x,a.y,a.z],null,void 0).join()),a[p.frequency]=e.frequency,a.frequency=e.frequency,f.push(a)}):angular.forEach(e["values-response"]["distinct-value"],function(e){var n={seriesName:v(_.without([p.values.seriesNameIndex>-1?e:null,t[p.facets.seriesNameIndex]],null,void 0)[0]),name:v(_.without([p.values.dataPointNameIndex>-1?e:null,t[p.facets.dataPointNameIndex]],null,void 0)[0]),xCategory:v(_.without([p.values.xCategoryAxisIndex>-1?e:null,t[p.facets.xCategoryAxisIndex]],null,void 0)[0]),x:v(_.without([p.values.xAxisIndex>-1?e:null,t[p.facets.xAxisIndex]],null,void 0)[0]),y:v(_.without([p.values.yAxisIndex>-1?e:null,t[p.facets.yAxisIndex]],null,void 0)[0]),z:v(_.without([p.values.zAxisIndex>-1?e:null,t[p.facets.zAxisIndex]],null,void 0)[0])};n.xCategory&&x.indexOf(n.xCategory)<0&&x.push(n.xCategory),n.name||(n.name=_.without([n.xCategory,n.x,n.y,n.z],null,void 0).join()),n[p.frequency]=e.frequency,n.frequency=e.frequency,f.push(n)}))}))}),t.all(L).then(function(){var n=[];return angular.forEach(N,function(t){angular.forEach(p.aggregates[t.name],function(i){angular.forEach(f,function(r){var s=_.without(_.map(r,function(t,e){var n=p[e+"Axis"];return"name"===e?n=p.dataPointName:"seriesName"===e&&(n=p.seriesName),t&&n&&"$frequency"!==n?u(n,t):null}),null,void 0);n.push(c.constraintValueCall(e,a,[t],l,s,i.type).then(function(t){r[i.axis]=Number(t["values-response"]["aggregate-result"][0]._value)}))})})}),t.all(n).then(function(){return{data:f.sort(function(t,e){return e.frequency-t.frequency}),categories:x}})})}1===C.length?angular.forEach(m,function(t){var e={xCategory:v(_.without([t[p.facets.xCategoryAxisIndex]],null,void 0)),x:v(_.without([t[p.facets.xAxisIndex]],null,void 0)),y:v(_.without([t[p.facets.yAxisIndex]],null,void 0)),z:v(_.without([t[p.facets.zAxisIndex]],null,void 0)),frequency:t[0].frequency};e[p.frequency]=t[0].frequency,f.push(e)}):console.log("TODO: mulitple bucket facets without values")}return{data:f.sort(function(t,e){return e.frequency-t.frequency}),categories:x}})},c.constraintValueCall=function(t,e,a,i,r,o){var u=s(t,e,a,i,r);return n.values("cooccurrence",{format:"json",aggregate:o,view:o?"aggregate":"all"},u).then(function(t){return t.data})},c.chartTypes=function(){return["line","spline","area","areaspline","column","bar","bubble","pie","scatter"]},c.aggregateTypes=function(){return[null,"sum","avg","min","max","median","count","stddev","stddev-population","correlation","covariance","covariance-population","variance","variance-population"]},c}])}();
!function(){"use strict";angular.module("ml.highcharts",["highcharts-ng","ml.common","ml.highcharts.tpls","ml.search","ui.bootstrap"])}(),function(){"use strict";angular.module("ml.highcharts").controller("EditChartConfigCtrl",["$uibModalInstance","$scope","HighchartsHelper","facets","highchartConfig","mlSearch",function(e,t,n,a,i,r){t.facetSortOptions={clone:!0,accept:function(e,t){return!0},allowDuplicates:!1},t.xSortOptions={accept:function(e,t){return t.modelValue&&t.modelValue.length<1}},t.mlSearch=r,t.chartFacetOptions=Object.keys(a);var s=t.chartFacetOptions[0];t.chartFacetOptions.push("$frequency"),t.aggregateTypes=n.aggregateTypes(),t.facets=a,t.highchartConfig=i||{options:{chart:{type:"bar"},tooltip:{style:{padding:10,fontWeight:"bold"}}},title:{text:"Title"},xAxis:{title:{text:s}},seriesNameMLConstraint:s,dataPointNameMLConstraint:null,xAxisMLConstraint:null,xAxisMLConstraintAggregate:null,xAxisCategoriesMLConstraint:null,xAxisCategoriesMLConstraintAggregate:null,yAxis:{title:{text:null}},yAxisMLConstraint:"$frequency",yAxisMLConstraintAggregate:null,zAxis:{title:{text:null}},zAxisMLConstraint:null,zAxisMLConstraintAggregate:null,size:{height:250},resultLimit:15},t.highchartConfig.xAxis||(t.highchartConfig.xAxis={title:{text:null}}),t.highchartConfig.yAxis||(t.highchartConfig.yAxis={title:{text:null}}),t.dataPointNameMLConstraint=_.without([t.highchartConfig.dataPointNameMLConstraint],null,void 0),t.seriesNameMLConstraint=_.without([t.highchartConfig.seriesNameMLConstraint],null,void 0),t.xAxisMLConstraint=_.without([t.highchartConfig.xAxisMLConstraint],null,void 0),t.xAxisCategoriesMLConstraint=_.without([t.highchartConfig.xAxisCategoriesMLConstraint],null,void 0),t.yAxisMLConstraint=_.without([t.highchartConfig.yAxisMLConstraint],null,void 0),t.zAxisMLConstraint=_.without([t.highchartConfig.zAxisMLConstraint],null,void 0);var o=function(){t.mlSearch.search()};t.chartTypes=n.chartTypes(),o(),t.$watch(function(){return t.highchartConfig.options.chart.type+t.highchartConfig.xAxis.title.text+t.highchartConfig.yAxis.title.text+t.highchartConfig.title.text+t.highchartConfig.resultLimit},function(){o()}),t.$watch(function(){return t.xAxisMLConstraint.length+""+t.yAxisMLConstraint.length+t.zAxisMLConstraint.length+t.xAxisCategoriesMLConstraint.length+t.seriesNameMLConstraint.length+t.dataPointNameMLConstraint.length+t.highchartConfig.xAxisMLConstraintAggregate+t.highchartConfig.yAxisMLConstraintAggregate+t.highchartConfig.zAxisMLConstraintAggregate},function(){t.highchartConfig.seriesNameMLConstraint=t.seriesNameMLConstraint[0],t.highchartConfig.dataPointNameMLConstraint=t.dataPointNameMLConstraint[0],t.highchartConfig.xAxisMLConstraint=t.xAxisMLConstraint[0],t.highchartConfig.yAxisMLConstraint=t.yAxisMLConstraint[0],t.highchartConfig.zAxisMLConstraint=t.zAxisMLConstraint[0],t.highchartConfig.xAxisCategoriesMLConstraint=t.xAxisCategoriesMLConstraint[0],o()}),t.save=function(){e.close(t.highchartConfig)}}]).factory("EditChartConfigDialog",["$uibModal","MLSearchFactory",function(e,t){return function(n,a,i){return e.open({templateUrl:"/ml-highcharts/templates/ml-highchart-config-modal.html",controller:"EditChartConfigCtrl",size:"lg",resolve:{facets:function(){return n},highchartConfig:function(){return a},mlSearch:function(){return t.newContext({queryOptions:i||"all"})}}}).result}}])}(),function(){"use strict";angular.module("ml.highcharts").directive("mlHighchart",["$q","HighchartsHelper","MLRest","MLSearchFactory",function(e,t,n,a){function i(e,n,i){e.mlSearch||(e.mlSearch=a.newContext());var r=e.mlSearch;e.structuredQuery&&(r=a.newContext(),r.addAdditionalQuery(e.structuredQuery));var s=function(){e.highchartConfig&&t.chartFromConfig(e.highchartConfig,r,e.callback).then(function(t){e.populatedConfig=t})},o=function(e){return function(){var t=e.apply(this,arguments);return t&&angular.isFunction(t.then)?t.then(function(e){return s(),e}):(s(),t)}},u=r.search;r.search=o(u),i.structuredQuery?e.$watch("structuredQuery",function(e){e&&!angular.equals({},e)&&s()},!0):i.mlSearch?e.$watch("mlSearch.results",function(e){e&&!angular.equals({},e)&&s()},!0):s()}return{restrict:"E",templateUrl:"/ml-highcharts/templates/ml-highchart.html",scope:{mlSearch:"=?",structuredQuery:"=?",highchartConfig:"=",callback:"&"},link:i}}])}(),function(){"use strict";angular.module("ml.highcharts").factory("HighchartsHelper",["$q","MLQueryBuilder","MLRest","MLSearchFactory",function(e,t,n,a){function i(e){var t=e.options.queryOptions;return l[t]||(l[t]=e.getStoredOptions(t)),l[t]}function r(e,t,n){var a={xCategoryAxis:e.xAxisCategoriesMLConstraint,xAxis:e.xAxisMLConstraint,yCategoryAxis:e.yAxisCategoriesMLConstraint,yAxis:e.yAxisMLConstraint,zAxis:e.zAxisMLConstraint,seriesName:e.seriesNameMLConstraint,dataPointName:e.dataPointNameMLConstraint,xCategoryAxisAggregate:e.xAxisCategoriesMLConstraintAggregate,xAxisAggregate:e.xAxisMLConstraintAggregate,yCategoryAxisAggregate:e.yAxisCategoriesMLConstraintAggregate,yAxisAggregate:e.yAxisMLConstraintAggregate,zAxisAggregate:e.zAxisMLConstraintAggregate};a.aggregates={},angular.forEach(a,function(e,t){e&&a[t+"Aggregate"]&&(a.aggregates[e]||(a.aggregates[e]=[]),a.aggregates[e].push({type:a[t+"Aggregate"],axis:t.substring(0,t.indexOf("Axis"))}))});var i=_.map(a.aggregates,function(e,t){return t});return n=_.filter(n,function(e){return i.indexOf(e)<0}),"$frequency"===e.xAxisCategoriesMLConstraint?a.frequency="xCategory":"$frequency"===e.xAxisMLConstraint?a.frequency="x":"$frequency"===e.yAxisCategoriesMLConstraint?a.frequency="yCategory":"$frequency"===e.yAxisMLConstraint?a.frequency="y":"$frequency"===e.zAxisMLConstraint&&(a.frequency="z"),a.facets={xCategoryAxisIndex:t.indexOf(a.xCategoryAxis),xAxisIndex:t.indexOf(a.xAxis),yCategoryAxisIndex:t.indexOf(a.yCategoryAxis),yAxisIndex:t.indexOf(a.yAxis),zAxisIndex:t.indexOf(a.zAxis),seriesNameIndex:t.indexOf(a.seriesName),dataPointNameIndex:t.indexOf(a.dataPointName)},a.values={xCategoryAxisIndex:n.indexOf(a.xCategoryAxis),xAxisIndex:n.indexOf(a.xAxis),yCategoryAxisIndex:n.indexOf(a.yCategoryAxis),yAxisIndex:n.indexOf(a.yAxis),zAxisIndex:n.indexOf(a.zAxis),seriesNameIndex:n.indexOf(a.seriesName),dataPointNameIndex:n.indexOf(a.dataPointName)},a}function s(e,t){return _.filter(e,function(e){return e&&e.name&&t.indexOf(e.name)>-1}).sort(function(e,n){var a=e.collection?1:100,i=n.collection?1:100;return t.indexOf(e.name)*a-t.indexOf(n.name)*i})}function o(e,t,n,a,i){var r=_.map(n,function(e){return e.range}),s=_.map(n,function(e){return e.collection}),o=[{name:"cooccurrence",collection:_.without(s,null,void 0),range:_.without(r,null,void 0),"values-option":["frequency-order","limit="+(a?a:"20")]}],u=e?angular.copy(e.getQuery().query):{queries:[]};i&&i.length&&u.queries.unshift.apply(u.queries,i);var c=e&&e.getText(),g={search:{options:{constraint:t},query:u,qtext:c||""}};return n.length>1?g.search.options.tuples=o:1===n.length&&(g.search.options.values=o),g}function u(e){if(1===e.length)return _.map(e[0].facetValues,function(t){return[{facetName:e[0].name,type:e[0].type,_value:t.value,frequency:t.frequency||t.count,query:{qtext:'"'+e[0].name+'":"'+t.name+'"'}}]});for(var t=[],n=u(e.slice(1)),a=0;a<n.length;a++)for(var i=0;i<e[0].facetValues.length;i++)t.push(_.flatten([{facetName:e[0].name,type:e[0].type,_value:e[0].facetValues[i].value,frequecy:e[0].facetValues[i].frequency,query:c(e[0].name,e[0].facetValues[i].name)},n[a]]));return t}function c(e,t){return{qtext:'"'+e+'":"'+t+'"'}}var g={},l={};return g.seriesData=function(e,t,n,a){var i=[];return angular.forEach(e,function(e){var t;if(e.seriesName?(t=_.filter(i,function(t){return t.name===e.seriesName})[0],t||(t={name:e.seriesName,data:[]},i.push(t))):t=i[0],t||(t={name:e.facetNames.join(" - "),data:[]},i.push(t)),e.xCategory){var a=n.indexOf(e.xCategory);t.data[a]=e}else t.data.push(e)}),(n.length||a.length)&&angular.forEach(i,function(e){angular.forEach(e.data,function(e){e.xCategory&&void 0===e.x&&(e.x=n.indexOf(e.xCategory)),e.yCategory&&void 0===e.y&&(e.y=a.indexOf(e.yCategory))}),angular.forEach(n,function(t,n){e.data[n]||(e.data[n]={})})}),i},g.chartFromConfig=function(t,n,r){var s=e.defer(),o=t.options.chart.type,u=t;return n||(n=a.newContext()),r&&(u.options.plotOptions={series:{cursor:"pointer",point:{events:{click:function(){var e=this.name||this.seriesName;r(angular.extend({facet:this.facetNames[0],value:e},this))}}}}}),i(n).then(function(e){e.options&&e.options.constraint&&e.options.constraint.length&&g.getChartData(n,e.options.constraint,t,t.resultLimit).then(function(e){u.series=g.seriesData(e.data,o,e.categories,e.yCategories),e.categories&&e.categories.length&&(u.xAxis.type="category",u.xAxis.categories=e.categories,u.xAxis.min=0,u.xAxis.max=u.xAxis.categories.length-1,"bubble"===u.options.chart.type&&(u.xAxis.categories.unshift(""),u.xAxis.categories.push(""),u.xAxis.max=u.xAxis.max+2,angular.forEach(u.series,function(e){angular.forEach(e.data,function(e){e.xCategory&&(e.x=e.x+1)})}))),e.yCategories&&e.yCategories.length&&(u.yAxis.type="category",u.yAxis.categories=e.yCategories,"bubble"===u.options.chart.type&&(u.yAxis.categories.unshift(""),u.yAxis.categories.push(""),angular.forEach(u.series,function(e){angular.forEach(e.data,function(e){e.yCategory&&(e.y=e.y+1)})}))),u.legend=u.legend||{},u.legend.enabled=void 0!==u.legend.enabled?u.legend.enabled:u.series.length>1,s.resolve(u)})}),s.promise},g.getChartData=function(t,a,i,l){var x,h=_.without([i.seriesNameMLConstraint,i.dataPointNameMLConstraint,i.xAxisCategoriesMLConstraint,i.xAxisMLConstraint,i.yAxisCategoriesMLConstraint,i.yAxisMLConstraint,i.zAxisMLConstraint],null,void 0,"$frequency"),f=[],y=[],C=[];if(t.results.facets){var d=angular.copy(t.results.facets);angular.forEach(d,function(e,t){e.name=t}),x=e.when(d)}else x=n.search({options:t.options.queryOptions}).then(function(e){return angular.forEach(e.data.facets,function(e,t){e.name=t}),e.data.facets});return x.then(function(x){if(a&&a.length){var d=s(a,h),m=[],A=[];angular.forEach(d,function(e){e.custom||e.range&&(e.range.bucket||e.range["computed-bucket"])?m.push(x[e.name]):A.push(e)});var p,v=_.map(A,function(e){return e.name}),L=_.map(m,function(e){return e.name}),M=r(i,L,v),q=function(e){return e?e._value:void 0};if(p=m.length>0?u(m):[[]],A.length>0){var N=[],I=_.filter(A,function(e){return!M.aggregates[e.name]}),O=_.filter(A,function(e){return M.aggregates[e.name]});return angular.forEach(p,function(e){var n=_.map(e,function(e){return e.query});I.length>0&&N.push(g.constraintValueCall(t,a,I,l,n).then(function(t){t["values-response"]&&(I.length>1?angular.forEach(t["values-response"].tuple,function(t){var n=t["distinct-value"],a={facetNames:h,seriesName:q(_.without([n[M.values.seriesNameIndex],e[M.facets.seriesNameIndex]],null,void 0)[0]),name:q(_.without([n[M.values.dataPointNameIndex],e[M.facets.dataPointNameIndex]],null,void 0)[0]),xCategory:q(_.without([n[M.values.xCategoryAxisIndex],e[M.facets.xCategoryAxisIndex]],null,void 0)[0]),x:q(_.without([n[M.values.xAxisIndex],e[M.facets.xAxisIndex]],null,void 0)[0]),yCategory:q(_.without([n[M.values.yCategoryAxisIndex],e[M.facets.yCategoryAxisIndex]],null,void 0)[0]),y:q(_.without([n[M.values.yAxisIndex],e[M.facets.yAxisIndex]],null,void 0)[0]),z:q(_.without([n[M.values.zAxisIndex],e[M.facets.zAxisIndex]],null,void 0)[0])};a.xCategory&&f.indexOf(a.xCategory)<0&&f.push(a.xCategory),a.yCategory&&y.indexOf(a.yCategory)<0&&y.push(a.yCategory),a.name||(a.name=_.without([a.seriesName,a.xCategory,a.x,a.yCategory,a.y,a.z],null,void 0).join()),a[M.frequency]=t.frequency,a.frequency=t.frequency,C.push(a)}):angular.forEach(t["values-response"]["distinct-value"],function(t){var n={facetNames:h,seriesName:q(_.without([M.values.seriesNameIndex>-1?t:null,e[M.facets.seriesNameIndex]],null,void 0)[0]),name:q(_.without([M.values.dataPointNameIndex>-1?t:null,e[M.facets.dataPointNameIndex]],null,void 0)[0]),xCategory:q(_.without([M.values.xCategoryAxisIndex>-1?t:null,e[M.facets.xCategoryAxisIndex]],null,void 0)[0]),x:q(_.without([M.values.xAxisIndex>-1?t:null,e[M.facets.xAxisIndex]],null,void 0)[0]),yCategory:q(_.without([M.values.yCategoryAxisIndex>-1?t:null,e[M.facets.yCategoryAxisIndex]],null,void 0)[0]),y:q(_.without([M.values.yAxisIndex>-1?t:null,e[M.facets.yAxisIndex]],null,void 0)[0]),z:q(_.without([M.values.zAxisIndex>-1?t:null,e[M.facets.zAxisIndex]],null,void 0)[0])};n.xCategory&&f.indexOf(n.xCategory)<0&&f.push(n.xCategory),n.yCategory&&y.indexOf(n.yCategory)<0&&y.push(n.yCategory),n.name||(n.name=_.without([n.xCategory,n.x,n.yCategory,n.y,n.z],null,void 0).join()),n[M.frequency]=t.frequency,n.frequency=t.frequency,C.push(n)}))}))}),e.all(N).then(function(){var n=[];return angular.forEach(O,function(e){angular.forEach(M.aggregates[e.name],function(i){angular.forEach(C,function(r){var s=_.without(_.map(r,function(e,t){var n=M[t+"Axis"];return"name"===t?n=M.dataPointName:"seriesName"===t&&(n=M.seriesName),e&&n&&"$frequency"!==n?c(n,e):null}),null,void 0);n.push(g.constraintValueCall(t,a,[e],l,s,i.type).then(function(e){r[i.axis]=Number(e["values-response"]["aggregate-result"][0]._value)}))})})}),e.all(n).then(function(){return{data:C.sort(function(e,t){return t.frequency-e.frequency}),categories:f,yCategories:y}})})}var w=[];return angular.forEach(p,function(e,i){var r={facetNames:h,seriesName:q(e[M.facets.seriesNameIndex]),name:q(e[M.facets.dataPointNameIndex]),xCategory:q(e[M.facets.xCategoryAxisIndex]),x:q(e[M.facets.xAxisIndex]),yCategory:q(e[M.facets.yCategoryAxisIndex]),y:q(e[M.facets.yAxisIndex]),z:q(e[M.facets.zAxisIndex])};if(1===m.length)r.frequency=e[0].frequency||e[0].count,r[M.frequency]=r.frequency;else{var s=_.map(e,function(e){return e.query}),u=o(t,a,[],l,s);u.search.options["return-results"]=!1,u.search.options["return-facets"]=!1,u.search.options["return-values"]=!1,u.search.options["return-metrics"]=!0,w.push(n.search({options:t.options.queryOptions},u).then(function(e){var t=e.data.total;r.frequency=t,r[M.frequency]=t}))}C.push(r)}),e.all(w).then(function(){return{data:C.sort(function(e,t){return t.frequency-e.frequency}),categories:f}})}})},g.constraintValueCall=function(e,t,a,i,r,s){var u=o(e,t,a,i,r);return n.values("cooccurrence",{format:"json",aggregate:s,view:s?"aggregate":"all"},u).then(function(e){return e.data})},g.chartTypes=function(){return["line","spline","area","areaspline","column","bar","bubble","pie","scatter"]},g.aggregateTypes=function(){return[null,"sum","avg","min","max","median","count","stddev","stddev-population","correlation","covariance","covariance-population","variance","variance-population"]},g}])}();